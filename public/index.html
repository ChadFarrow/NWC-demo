<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- AGGRESSIVE CACHE BUSTING - Force no caching at all levels -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, s-maxage=0, proxy-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Surrogate-Control" content="no-store">
    <meta http-equiv="Last-Modified" content="0">
    <meta http-equiv="ETag" content="no-cache">
    <title>V4V Lightning Payment Tester</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- DYNAMIC CACHE BUSTING SCRIPT - Runs before anything else -->
    <script>
        (function() {
            'use strict';
            
            // Generate unique cache-busting parameters
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 15);
            const sessionId = sessionStorage.getItem('v4v_session_id') || Math.random().toString(36).substring(2, 15);
            sessionStorage.setItem('v4v_session_id', sessionId);
            
            // Create aggressive cache-busting URL parameters
            window.CACHE_BUST_PARAMS = {
                v: '2025-01-27-ULTRA-AGGRESSIVE',
                t: timestamp,
                r: random,
                s: sessionId,
                cb: 'NO_CACHE_EVER',
                nocache: 'true',
                bust: 'aggressive',
                ver: '1.0.0',
                build: timestamp
            };
            
            // Function to add cache-busting to any URL
            window.bustCache = function(url) {
                if (!url) return url;
                const separator = url.includes('?') ? '&' : '?';
                const params = Object.entries(window.CACHE_BUST_PARAMS)
                    .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                    .join('&');
                return `${url}${separator}${params}`;
            };
            
            // Override fetch to add cache-busting headers
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                const bustedUrl = window.bustCache(url);
                const newOptions = {
                    ...options,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0',
                        ...options.headers
                    }
                };
                return originalFetch(bustedUrl, newOptions);
            };
            
            // Force clear all possible caches
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Clear localStorage and sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            
            console.log('üöÄ ULTRA-AGGRESSIVE CACHE BUSTING ACTIVATED');
            console.log('üîß Cache bust params:', window.CACHE_BUST_PARAMS);
            console.log('‚è∞ Timestamp:', new Date(timestamp).toISOString());
        })();
    </script>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    <div class="container">
        <header class="header">
            <div class="header-flex">
                <img src="logo.png" alt="V4V Lightning Payment Tester Logo" class="main-logo">
                <div class="header-text">
                    <h1 class="title">V4V Lightning Payment Tester</h1>
                    <p class="subtitle">Look up and test payment splits in podcast value blocks</p>
                </div>
            </div>
        </header>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üì°</div>
                <h2 class="card-title">RSS Feed</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Podcast RSS Feed URL</label>
                <input 
                    type="url" 
                    class="form-input" 
                    placeholder="https://raw.githubusercontent.com/ChadFarrow/lnurl-test-feed/main/public/..."
                    value="https://v4v-lightning-payment-tester-o9dcyzifv-chadfs-projects.vercel.app/metaboost-test-feed.xml"
                >
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="parseValueBlock()">
                    <span class="lightning-icon">‚ö°</span> Parse Value Block
                </button>
                <button class="btn btn-success" onclick="loadTestFeed()">
                    üìÇ Load Test Feed
                </button>
                <button class="btn btn-danger" onclick="clearSettings()">
                    üóëÔ∏è Clear Settings
                </button>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üíº</div>
                <h2 class="card-title">Wallet Connection</h2>
                <div class="card-subtitle">üîí Local mode - Enter your private key manually</div>
            </div>
            <div class="form-group">
                <label class="form-label">Nostr Wallet Connect (NWC) String</label>
                <input 
                    type="text" 
                    class="form-input" 
                    placeholder="nostr+walletconnect://your-nwc-string-here"
                    value=""
                >
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="connectWallet()">
                    üîó Connect Wallet
                </button>
                <button class="btn btn-info" onclick="testRelayConnection()">
                    üîç Test Relay
                </button>
                <button class="btn btn-warning" onclick="testWalletCapabilitiesStandalone()">
                    ‚ö° Test Wallet
                </button>
                <button class="btn btn-info" onclick="debugNWCConnection()">
                    üîß Debug NWC
                </button>
                <button class="btn btn-success" onclick="testKeysend()">
                    üîë Test Keysend
                </button>
                <button class="btn btn-warning" onclick="testNodeConnectivity()">
                    üîç Test Node Connectivity
                </button>
                <button class="btn btn-danger" onclick="forceRefresh()" title="Force refresh to clear cache">
                    üîÑ Force Refresh
                </button>
                <button class="btn btn-warning" onclick="nuclearCacheClear()" title="Nuclear option - clears ALL caches and storage">
                    ‚ò¢Ô∏è Nuclear Clear
                </button>
            </div>
            <div id="wallet-info"></div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üí∏</div>
                <h2 class="card-title">Send Boost Metadata (metaBoost API)</h2>
            </div>
            <div id="payment-form-container">
                <div class="form-group">
                    <label class="form-label">Amount (sats)</label>
                    <input type="number" class="form-input" id="payment-amount" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <input type="text" class="form-input" id="payment-message" maxlength="240">
                </div>
                <div class="form-group">
                    <label class="form-label">Recipients (select one or more splits)</label>
                    <label style="display:block; margin-bottom:0.5em;"><input type="checkbox" id="select-all-recipients"> Select All</label>
                    <div id="recipient-checkboxes"></div>
                </div>
                <div class="form-group" id="payment-proof-group">
                    <label class="form-label">Payment Proof (preimage, invoice, etc.)</label>
                    <input type="text" class="form-input" id="payment-proof" required placeholder="Paste payment proof here">
                </div>
                <button class="btn btn-primary" type="button" id="metaboost-submit-btn">Send metaBoost Metadata</button>
                <button class="btn btn-secondary" style="margin-top:1rem; width:100%;" onclick="sendNormalBoost()">Send Boost</button>
                <div style="margin-top: 1rem; font-size: 0.95em; color: #aaa;">
                    <strong>How this works:</strong> Pay with your wallet, then paste the payment proof above. This will POST boost metadata to the metaBoost endpoint, following the <a href="https://github.com/Podcastindex-org/podcast-namespace/discussions/676" target="_blank">Podcastindex metaBoost proposal</a>.
                </div>
            </div>
        </div>
        <div class="status-bar">
            <span class="status-indicator"></span>
            Settings saved locally ‚Ä¢ RSS: https://raw.githubusercontent.com... ‚Ä¢ NWC: nostr+walletconnect://pa80990...
        </div>
        
        <!-- CACHE STATUS INDICATOR -->
        <div class="card cache-status-card">
            <div class="card-header">
                <div class="card-icon">üîß</div>
                <h2 class="card-title">Cache Status & Control</h2>
                <div class="card-subtitle">üîí Local nostr-tools only - Browser extensions disabled</div>
            </div>
            <div class="cache-controls">
                <div class="cache-info">
                    <span class="cache-label">Session ID:</span>
                    <span id="session-id" class="cache-value">Loading...</span>
                </div>
                <div class="cache-info">
                    <span class="cache-label">Cache Bust:</span>
                    <span id="cache-bust-status" class="cache-value">Loading...</span>
                </div>
                <div class="cache-info">
                    <span class="cache-label">Scripts Loaded:</span>
                    <span id="scripts-status" class="cache-value">Loading...</span>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-info" onclick="checkCacheStatus()" title="Check current cache status">
                    üîç Check Status
                </button>
                <button class="btn btn-secondary" onclick="testCacheBusting()" title="Test cache busting functionality">
                    üß™ Test Cache Bust
                </button>
                <button class="btn btn-success" onclick="forceLoadScripts()" title="Manually trigger script loading">
                    üöÄ Force Load Scripts
                </button>
            </div>
        </div>
    </div>
    <!-- Noble secp256k1 for crypto operations -->
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <!-- Bech32 for address encoding -->
    <script src="https://bundle.run/bech32@2.0.0"></script>

    
    <!-- DYNAMIC SCRIPT LOADING WITH ULTRA-AGGRESSIVE CACHE BUSTING -->
    <script>
        (function() {
            'use strict';
            
            // Wait for cache busting to be ready
            if (window.CACHE_BUST_PARAMS) {
                loadScriptsWithCacheBusting();
            } else {
                // Fallback if cache busting isn't ready
                setTimeout(loadScriptsWithCacheBusting, 100);
            }
            
            function loadScriptsWithCacheBusting() {
                console.log('üîÑ Loading scripts with ULTRA-AGGRESSIVE cache busting...');
                
                // Load nostr-tools.umd.js first (required for NWC encryption)
                // üîí FORCING LOCAL NOSTR-TOOLS ONLY - Browser extensions disabled
                const nostrToolsScript = document.createElement('script');
                nostrToolsScript.src = window.bustCache('nostr-tools.umd.js');
                nostrToolsScript.onload = () => {
                    console.log('‚úÖ nostr-tools.umd.js loaded with cache busting');
                    
                    // Create aliases for NostrTools
                    if (typeof window.NostrTools !== 'undefined') {
                        window.nostrTools = window.NostrTools;
                        window.nostr = window.NostrTools;
                        console.log('‚úÖ NostrTools aliases created (nostrTools, nostr)');
                    }
                    
                    // Load nwcjs.js with cache busting
                    const nwcjsScript = document.createElement('script');
                    nwcjsScript.src = window.bustCache('nwcjs.js');
                    nwcjsScript.onload = () => {
                        console.log('‚úÖ nwcjs.js loaded with cache busting');
                        
                        // Load script-v2.js with cache busting
                        const scriptV2 = document.createElement('script');
                        scriptV2.src = window.bustCache('script-v2.js');
                        scriptV2.onload = () => {
                            console.log('‚úÖ script-v2.js loaded with cache busting');
                            
                            // Load main.js module
                            const mainScript = document.createElement('script');
                            mainScript.type = 'module';
                            mainScript.src = window.bustCache('/src/main.js');
                            mainScript.onload = () => {
                                console.log('‚úÖ main.js loaded with cache busting');
                                console.log('üöÄ ALL SCRIPTS LOADED WITH ULTRA-AGGRESSIVE CACHE BUSTING!');
                                
                                // Trigger a custom event when all scripts are loaded
                                window.dispatchEvent(new CustomEvent('allScriptsLoaded'));
                            };
                            mainScript.onerror = (e) => {
                                console.error('‚ùå Failed to load main.js:', e);
                            };
                            document.head.appendChild(mainScript);
                        };
                        scriptV2.onerror = (e) => {
                            console.error('‚ùå Failed to load script-v2.js:', e);
                        };
                        document.head.appendChild(scriptV2);
                    };
                    nwcjsScript.onerror = (e) => {
                        console.error('‚ùå Failed to load nwcjs.js:', e);
                    };
                    document.head.appendChild(nwcjsScript);
                };
                nostrToolsScript.onerror = (e) => {
                    console.error('‚ùå Failed to load nostr-tools.umd.js:', e);
                };
                document.head.appendChild(nostrToolsScript);
            }
        })();
    </script>
    
    <!-- IMMEDIATE KEYSEND FIX - Override sendKeysendWithNWC to use multi_pay_keysend -->
    <script>
        console.log('üöÄ Loading immediate keysend fix override v4 - BYPASS CONNECTIVITY...');
        console.log('üïê Timestamp:', new Date().toISOString());
        console.log('üîß Cache-busting version: 1754838300-fix_now-nocache');
        
                 // IMMEDIATELY override the sendKeysendWithNWC function - no waiting
         window.sendKeysendWithNWC = async function(nwcString, pubkey, amount, message) {
                     console.log('üîß [OVERRIDE v4] Using working multi_pay_keysend method');
                     console.log(`Target: ${pubkey.substring(0, 16)}... Amount: ${amount} sats`);
                     
                     // Skip connectivity check to avoid undefined errors
                     console.log('üöÄ Skipping connectivity check - proceeding directly with payment');
                     const connectivityTest = {
                         reachable: true,
                         source: 'override_bypass',
                         message: 'Connectivity check bypassed in override'
                     };
                     
                     try {
                         if (typeof nwcjs === 'undefined') {
                             throw new Error('nwcjs library not loaded');
                         }
                         
                         // Get or create NWC info
                         let nwcInfo = nwcjs.nwc_infos.find(info => 
                             nwcString.includes(info.wallet_pubkey) && nwcString.includes(info.relay)
                         );
                         
                         if (!nwcInfo) {
                             nwcInfo = nwcjs.processNWCstring(nwcString);
                         }
                         
                         // Use multi_pay_keysend since pay_keysend is broken in Alby
                         const keysendArray = [{
                             pubkey: pubkey,
                             amount: amount * 1000, // msat
                             tlv_records: [{
                                 type: 34349334,
                                 value: nwcjs.bytesToHex(new TextEncoder().encode(message || ""))
                             }]
                         }];
                         
                         const result = await nwcjs.multiPayKeysend(nwcInfo, keysendArray, 20);
                         console.log('üîß Multi-keysend result:', result);
                         
                         if (result && result.result) {
                             return {
                                 success: true,
                                 preimage: result.result.preimage || 'keysend_sent',
                                 result: result,
                                 connectivity: connectivityTest
                             };
                         } else {
                             return {
                                 success: false,
                                 error: result?.error?.message || 'Keysend payment failed',
                                 result: result,
                                 connectivity: connectivityTest
                             };
                         }
                     } catch (error) {
                         console.error('‚ùå Keysend override error:', error);
                         return {
                             success: false,
                             error: error.message,
                             connectivity: connectivityTest
                         };
                     }
                 };
        };
        
                 // Also add a connectivity test stub to prevent undefined errors
         window.testNodeConnectivity = async function(pubkey) {
             console.log('üîç Testing node connectivity for:', pubkey);
             
             try {
                 // Check if pubkey format is valid
                 if (!/^[0-9a-fA-F]{66}$/.test(pubkey)) {
                     return {
                         reachable: false,
                         source: 'format_validation',
                         message: 'Invalid pubkey format - expected 66 character hex string'
                     };
                 }
                 
                 // Check if pubkey starts with valid Lightning Network prefixes
                 const validPrefixes = ['02', '03'];
                 if (!validPrefixes.includes(pubkey.substring(0, 2))) {
                     return {
                         reachable: false,
                         source: 'prefix_validation',
                         message: 'Invalid pubkey prefix - expected 02 or 03 for Lightning Network nodes'
                     };
                 }
                 
                 // Try to get node info from common Lightning Network explorers
                 const explorers = [
                     `https://amboss.space/node/${pubkey}`,
                     `https://1ml.com/node/${pubkey}`,
                     `https://lightningnetwork.plus/node/${pubkey}`
                 ];
                 
                 for (const explorer of explorers) {
                     try {
                         console.log(`Checking ${explorer}...`);
                         const response = await fetch(explorer, { 
                             method: 'HEAD',
                             mode: 'no-cors' // Avoid CORS issues
                         });
                         console.log(`‚úÖ Node found on ${explorer}`);
                         return { 
                             reachable: true, 
                             source: explorer,
                             message: 'Node appears to be online and reachable'
                         };
                     } catch (e) {
                         console.log(`‚ùå ${explorer} check failed:`, e.message);
                     }
                 }
                 
                 return {
                     reachable: false,
                     source: 'connectivity_test',
                     message: 'Node not reachable - may be offline, unreachable, or on different network'
                 };
                 
             } catch (error) {
                 console.error('Node connectivity test error:', error);
                 return {
                     reachable: false,
                     source: 'test_error',
                     message: `Connectivity test failed: ${error.message}`
                 };
             }
         };
        
                 console.log('‚úÖ sendKeysendWithNWC override installed immediately');
         console.log('‚úÖ testNodeConnectivity stub installed');
         console.log('üß™ Test commands available:');
         console.log('   - window.testOverride() - Test if override is working');
         console.log('   - window.forceRefresh() - Force refresh to clear cache');
         console.log('üïê Override loaded at:', new Date().toISOString());
         console.log('üîß Cache-busting parameters: v=20250810-final&t=1754838300&cb=fix_now&nocache=true');
         
         // Verify override is working
         setTimeout(() => {
             if (typeof window.sendKeysendWithNWC === 'function') {
                 console.log('‚úÖ VERIFICATION: sendKeysendWithNWC override is active');
                 console.log('üîß Function source:', window.sendKeysendWithNWC.toString().substring(0, 100) + '...');
             } else {
                 console.error('‚ùå VERIFICATION FAILED: sendKeysendWithNWC override not found!');
             }
         }, 1000);
         
         // ULTRA-AGGRESSIVE FORCE REFRESH FUNCTION
         window.forceRefresh = function() {
             console.log('üîÑ ULTRA-AGGRESSIVE FORCE REFRESH ACTIVATED...');
             
             // Clear all possible storage
             if (typeof localStorage !== 'undefined') { 
                 localStorage.clear(); 
                 console.log('‚úÖ localStorage cleared');
             }
             if (typeof sessionStorage !== 'undefined') { 
                 sessionStorage.clear(); 
                 console.log('‚úÖ sessionStorage cleared');
             }
             
             // Clear caches
             if ('caches' in window) {
                 caches.keys().then(names => {
                     names.forEach(name => {
                         caches.delete(name);
                         console.log(`‚úÖ Cache cleared: ${name}`);
                     });
                 });
             }
             
             // Force reload with cache busting
             const timestamp = Date.now();
             const random = Math.random().toString(36).substring(2, 15);
             const bustedUrl = `${window.location.pathname}?t=${timestamp}&r=${random}&bust=force&nocache=true&cb=ULTRA_AGGRESSIVE`;
             
             console.log('üöÄ Reloading with busted URL:', bustedUrl);
             window.location.href = bustedUrl;
         };
         
         // Nuclear option for extreme cache clearing
         window.nuclearCacheClear = function() {
             console.log('‚ò¢Ô∏è NUCLEAR CACHE CLEAR ACTIVATED...');
             
             // Clear everything
             localStorage.clear();
             sessionStorage.clear();
             
             // Clear caches
             if ('caches' in window) {
                 caches.keys().then(names => {
                     names.forEach(name => caches.delete(name));
                 });
             }
             
             // Clear indexedDB
             if ('indexedDB' in window) {
                 indexedDB.databases().then(dbs => {
                     dbs.forEach(db => {
                         indexedDB.deleteDatabase(db.name);
                     });
                 });
             }
             
             // Force hard reload
             window.location.reload(true);
         };
         
         // Cache status checking functions
         window.checkCacheStatus = function() {
             console.log('üîç Checking cache status...');
             
             const sessionId = sessionStorage.getItem('v4v_session_id') || 'Not set';
             const cacheBustStatus = window.CACHE_BUST_PARAMS ? 'Active' : 'Inactive';
             
             // Enhanced script status checking
             let scriptsStatus = 'Checking...';
             if (typeof nostr !== 'undefined') {
                 scriptsStatus += ' nostr-tools‚úÖ';
             } else {
                 scriptsStatus += ' nostr-tools‚ùå';
             }
             if (typeof nwcjs !== 'undefined') {
                 scriptsStatus += ' nwcjs‚úÖ';
             } else {
                 scriptsStatus += ' nwcjs‚ùå';
             }
             if (typeof window.sendKeysendWithNWC === 'function') {
                 scriptsStatus += ' override‚úÖ';
             } else {
                 scriptsStatus += ' override‚ùå';
             }
             
             // Update UI
             document.getElementById('session-id').textContent = sessionId;
             document.getElementById('cache-bust-status').textContent = cacheBustStatus;
             document.getElementById('scripts-status').textContent = scriptsStatus;
             
             console.log('üìä Cache Status:', {
                 sessionId,
                 cacheBustStatus,
                 scriptsStatus,
                 cacheBustParams: window.CACHE_BUST_PARAMS,
                 nostrTools: typeof nostr !== 'undefined',
                 nwcjs: typeof nwcjs !== 'undefined',
                 override: typeof window.sendKeysendWithNWC === 'function'
             });
             
             return { sessionId, cacheBustStatus, scriptsStatus };
         };
         
         window.testCacheBusting = function() {
             console.log('üß™ Testing cache busting functionality...');
             
             if (!window.CACHE_BUST_PARAMS) {
                 alert('‚ùå Cache busting not active!');
                 return false;
             }
             
             const testUrl = 'test.js';
             const bustedUrl = window.bustCache(testUrl);
             
             console.log('üß™ Test URL:', testUrl);
             console.log('üß™ Busted URL:', bustedUrl);
             
             alert(`‚úÖ Cache busting test successful!\n\nOriginal: ${testUrl}\nBusted: ${bustedUrl}`);
             return true;
         };
         
         // Auto-update cache status every 5 seconds
         setInterval(() => {
             if (document.getElementById('session-id')) {
                 window.checkCacheStatus();
             }
         }, 5000);
         
         // Manual script loading trigger
         window.forceLoadScripts = function() {
             console.log('üöÄ Manually triggering script loading...');
             if (typeof loadScriptsWithCacheBusting === 'function') {
                 loadScriptsWithCacheBusting();
             } else {
                 console.log('‚ö†Ô∏è Script loading function not available, reloading page...');
                 window.location.reload();
             }
         };
         
         // Test override function
         window.testOverride = function() {
             console.log('üß™ Testing override functionality...');
             console.log('sendKeysendWithNWC type:', typeof window.sendKeysendWithNWC);
             if (typeof window.sendKeysendWithNWC === 'function') {
                 console.log('‚úÖ Override is a function');
                 console.log('Function source preview:', window.sendKeysendWithNWC.toString().substring(0, 200));
                 return true;
             } else {
                 console.error('‚ùå Override is not a function');
                 return false;
             }
         };
     </script>
    
    <!-- Standalone MetaBoost Handler v2 -->
    <script>
        console.log('üîß Loading standalone metaBoost handler v2...');
        console.log('üö® CACHE TEST: Script loaded at', new Date().toISOString());
        
        // Add a global function to check Alby methods manually
        window.checkAlbyMethods = async function() {
            try {
                const nwcString = document.querySelector('input[placeholder*="nostr+walletconnect"]').value;
                if (!nwcString) {
                    alert('Please enter your NWC string first');
                    return;
                }
                
                const nwcInfo = nwcjs.processNWCstring(nwcString);
                const info = await nwcjs.getInfo(nwcInfo);
                const methods = info?.result?.methods || [];
                
                alert(`üîç ALBY SUPPORTED METHODS:\n\n${methods.join('\n')}\n\nSupports keysend: ${methods.includes('pay_keysend') ? '‚úÖ YES' : '‚ùå NO'}`);
                console.log('Full wallet info:', info);
            } catch (e) {
                alert('Error checking methods: ' + e.message);
            }
        };
        
        // Wait for DOM and other scripts to load
        setTimeout(() => {
            const submitBtn = document.getElementById('metaboost-submit-btn');
            if (submitBtn) {
                console.log('‚úÖ Found metaBoost submit button, adding click handler');
                
                submitBtn.addEventListener('click', async function(event) {
                    console.log('üöÄ MetaBoost button clicked!');
                    event.preventDefault();
                    
                    try {
                        // Get form data
                        const amount = document.getElementById('payment-amount').value;
                        const message = document.getElementById('payment-message').value;
                        const paymentProof = document.getElementById('payment-proof').value;
                        
                        if (!amount || !paymentProof) {
                            alert('Please enter amount and payment proof');
                            return;
                        }
                        
                        // Get selected recipients
                        const recipientCheckboxes = document.querySelectorAll('#recipient-checkboxes input[type="checkbox"]:checked');
                        const recipients = Array.from(recipientCheckboxes).map(cb => cb.value);
                        
                        if (recipients.length === 0) {
                            alert('Please select at least one recipient');
                            return;
                        }
                        
                        // Show loading state
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = 'üì§ Sending...';
                        submitBtn.disabled = true;
                        
                        // Prepare metaBoost data
                        const metaBoostData = {
                            amount: parseInt(amount),
                            paymentProof: paymentProof,
                            message: message || '',
                            action: 'boost',
                            boostId: `boost_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            value_msat: parseInt(amount) * 1000,
                            value_msat_total: parseInt(amount) * 1000,
                            recipients: recipients,
                            podcast: window._lastPodcastTitle || 'Unknown Podcast',
                            episode: window._lastEpisodeTitle || 'Unknown Episode',
                            feedUrl: document.querySelector('input[type="url"]').value,
                            appName: 'V4V Lightning Payment Tester',
                            senderName: 'Anonymous Tester',
                            timestamp: new Date().toISOString(),
                            ts: Math.floor(Date.now() / 1000),
                            paymentInfo: {
                                type: 'lightning',
                                network: 'mainnet',
                                method: paymentProof.startsWith('lnbc') ? 'invoice' : 'keysend'
                            }
                        };
                        
                        console.log('üì§ Sending metaBoost:', metaBoostData);
                        
                        // Send to API
                        const response = await fetch('/api/metaboost', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(metaBoostData)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('‚úÖ MetaBoost sent successfully:', result);
                        
                        // Show success and create history entry
                        submitBtn.innerHTML = '‚úÖ Sent Successfully!';
                        
                        // Create metaBoost history section
                        const container = document.getElementById('payment-form-container');
                        let historySection = document.getElementById('boost-history');
                        if (!historySection) {
                            historySection = document.createElement('div');
                            historySection.id = 'boost-history';
                            historySection.innerHTML = '<h3 style="margin-top: 2rem; color: #0066cc;">üìú Recent MetaBoosts</h3>';
                            container.appendChild(historySection);
                        }
                        
                        // Add boost entry
                        const boostEntry = document.createElement('div');
                        boostEntry.style.cssText = `
                            margin-top: 1rem;
                            padding: 1rem;
                            background: #2a2a2a;
                            border: 1px solid #00cc00;
                            border-radius: 8px;
                            color: white;
                            animation: pulse 0.5s ease;
                        `;
                        
                        boostEntry.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <h4 style="margin: 0; color: #00cc00;">‚úÖ NEW ${amount} sats</h4>
                                <span style="color: #999; font-size: 0.9rem;">${new Date().toLocaleString()}</span>
                            </div>
                            <div><strong>Podcast:</strong> ${metaBoostData.podcast}</div>
                            <div><strong>Episode:</strong> ${metaBoostData.episode}</div>
                            ${message ? `<div><strong>Message:</strong> <em>"${message}"</em></div>` : ''}
                            <div><strong>Boost ID:</strong> <code>${metaBoostData.boostId}</code></div>
                            <div><strong>Recipients:</strong> ${recipients.join(', ')}</div>
                        `;
                        
                        historySection.appendChild(boostEntry);
                        
                        // Reset form after 2 seconds
                        setTimeout(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            document.getElementById('payment-amount').value = '';
                            document.getElementById('payment-message').value = '';
                            document.getElementById('payment-proof').value = '';
                        }, 2000);
                        
                    } catch (error) {
                        console.error('‚ùå MetaBoost Error:', error);
                        submitBtn.innerHTML = `‚ùå Error: ${error.message}`;
                        submitBtn.disabled = false;
                        
                        setTimeout(() => {
                            submitBtn.innerHTML = 'Send metaBoost Metadata';
                        }, 3000);
                    }
                });
                
                console.log('‚úÖ MetaBoost handler setup complete');
            } else {
                console.error('‚ùå Could not find metaBoost submit button');
            }
        }, 1000);
    </script>
</body>
</html>
