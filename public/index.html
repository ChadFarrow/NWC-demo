<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V4V Lightning Payment Tester</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    <div class="container">
        <header class="header">
            <div class="header-flex">
                <img src="logo.png" alt="V4V Lightning Payment Tester Logo" class="main-logo">
                <div class="header-text">
                    <h1 class="title">V4V Lightning Payment Tester</h1>
                    <p class="subtitle">Look up and test payment splits in podcast value blocks</p>
                </div>
            </div>
        </header>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üì°</div>
                <h2 class="card-title">RSS Feed</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Podcast RSS Feed URL</label>
                <input 
                    type="url" 
                    class="form-input" 
                    placeholder="https://raw.githubusercontent.com/ChadFarrow/lnurl-test-feed/main/public/..."
                    value="https://v4v-lightning-payment-tester-o9dcyzifv-chadfs-projects.vercel.app/metaboost-test-feed.xml"
                >
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="parseValueBlock()">
                    <span class="lightning-icon">‚ö°</span> Parse Value Block
                </button>
                <button class="btn btn-success" onclick="loadTestFeed()">
                    üìÇ Load Test Feed
                </button>
                <button class="btn btn-danger" onclick="clearSettings()">
                    üóëÔ∏è Clear Settings
                </button>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üíº</div>
                <h2 class="card-title">Wallet Connection</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Nostr Wallet Connect (NWC) String</label>
                <input 
                    type="text" 
                    class="form-input" 
                    placeholder="nostr+walletconnect://your-nwc-string-here"
                    value=""
                >
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="connectWallet()">
                    üîó Connect Wallet
                </button>
                <button class="btn btn-info" onclick="testRelayConnection()">
                    üîç Test Relay
                </button>
                <button class="btn btn-warning" onclick="testWalletCapabilitiesStandalone()">
                    ‚ö° Test Wallet
                </button>
                <button class="btn btn-info" onclick="debugNWCConnection()">
                    üîß Debug NWC
                </button>
            </div>
            <div id="wallet-info"></div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üí∏</div>
                <h2 class="card-title">Send Boost Metadata (metaBoost API)</h2>
            </div>
            <div id="payment-form-container">
                <div class="form-group">
                    <label class="form-label">Amount (sats)</label>
                    <input type="number" class="form-input" id="payment-amount" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <input type="text" class="form-input" id="payment-message" maxlength="240">
                </div>
                <div class="form-group">
                    <label class="form-label">Recipients (select one or more splits)</label>
                    <label style="display:block; margin-bottom:0.5em;"><input type="checkbox" id="select-all-recipients"> Select All</label>
                    <div id="recipient-checkboxes"></div>
                </div>
                <div class="form-group" id="payment-proof-group">
                    <label class="form-label">Payment Proof (preimage, invoice, etc.)</label>
                    <input type="text" class="form-input" id="payment-proof" required placeholder="Paste payment proof here">
                </div>
                <button class="btn btn-primary" type="button" id="metaboost-submit-btn">Send metaBoost Metadata</button>
                <button class="btn btn-secondary" style="margin-top:1rem; width:100%;" onclick="sendNormalBoost()">Send Boost</button>
                <div style="margin-top: 1rem; font-size: 0.95em; color: #aaa;">
                    <strong>How this works:</strong> Pay with your wallet, then paste the payment proof above. This will POST boost metadata to the metaBoost endpoint, following the <a href="https://github.com/Podcastindex-org/podcast-namespace/discussions/676" target="_blank">Podcastindex metaBoost proposal</a>.
                </div>
            </div>
        </div>
        <div class="status-bar">
            <span class="status-indicator"></span>
            Settings saved locally ‚Ä¢ RSS: https://raw.githubusercontent.com... ‚Ä¢ NWC: nostr+walletconnect://pa80990...
        </div>
    </div>
    <script src="nostr-tools.umd.js"></script>
    <script type="module" src="/src/main.js"></script>
    <script src="script.js"></script>
    
    <!-- Standalone MetaBoost Handler -->
    <script>
        console.log('üîß Loading standalone metaBoost handler...');
        
        // Wait for DOM and other scripts to load
        setTimeout(() => {
            const submitBtn = document.getElementById('metaboost-submit-btn');
            if (submitBtn) {
                console.log('‚úÖ Found metaBoost submit button, adding click handler');
                
                submitBtn.addEventListener('click', async function(event) {
                    console.log('üöÄ MetaBoost button clicked!');
                    event.preventDefault();
                    
                    try {
                        // Get form data
                        const amount = document.getElementById('payment-amount').value;
                        const message = document.getElementById('payment-message').value;
                        const paymentProof = document.getElementById('payment-proof').value;
                        
                        if (!amount || !paymentProof) {
                            alert('Please enter amount and payment proof');
                            return;
                        }
                        
                        // Get selected recipients
                        const recipientCheckboxes = document.querySelectorAll('#recipient-checkboxes input[type="checkbox"]:checked');
                        const recipients = Array.from(recipientCheckboxes).map(cb => cb.value);
                        
                        if (recipients.length === 0) {
                            alert('Please select at least one recipient');
                            return;
                        }
                        
                        // Show loading state
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = 'üì§ Sending...';
                        submitBtn.disabled = true;
                        
                        // Prepare metaBoost data
                        const metaBoostData = {
                            amount: parseInt(amount),
                            paymentProof: paymentProof,
                            message: message || '',
                            action: 'boost',
                            boostId: `boost_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            value_msat: parseInt(amount) * 1000,
                            value_msat_total: parseInt(amount) * 1000,
                            recipients: recipients,
                            podcast: window._lastPodcastTitle || 'Unknown Podcast',
                            episode: window._lastEpisodeTitle || 'Unknown Episode',
                            feedUrl: document.querySelector('input[type="url"]').value,
                            appName: 'V4V Lightning Payment Tester',
                            senderName: 'Anonymous Tester',
                            timestamp: new Date().toISOString(),
                            ts: Math.floor(Date.now() / 1000),
                            paymentInfo: {
                                type: 'lightning',
                                network: 'mainnet',
                                method: paymentProof.startsWith('lnbc') ? 'invoice' : 'keysend'
                            }
                        };
                        
                        console.log('üì§ Sending metaBoost:', metaBoostData);
                        
                        // Send to API
                        const response = await fetch('/api/metaboost', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(metaBoostData)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('‚úÖ MetaBoost sent successfully:', result);
                        
                        // Show success and create history entry
                        submitBtn.innerHTML = '‚úÖ Sent Successfully!';
                        
                        // Create metaBoost history section
                        const container = document.getElementById('payment-form-container');
                        let historySection = document.getElementById('boost-history');
                        if (!historySection) {
                            historySection = document.createElement('div');
                            historySection.id = 'boost-history';
                            historySection.innerHTML = '<h3 style="margin-top: 2rem; color: #0066cc;">üìú Recent MetaBoosts</h3>';
                            container.appendChild(historySection);
                        }
                        
                        // Add boost entry
                        const boostEntry = document.createElement('div');
                        boostEntry.style.cssText = `
                            margin-top: 1rem;
                            padding: 1rem;
                            background: #2a2a2a;
                            border: 1px solid #00cc00;
                            border-radius: 8px;
                            color: white;
                            animation: pulse 0.5s ease;
                        `;
                        
                        boostEntry.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <h4 style="margin: 0; color: #00cc00;">‚úÖ NEW ${amount} sats</h4>
                                <span style="color: #999; font-size: 0.9rem;">${new Date().toLocaleString()}</span>
                            </div>
                            <div><strong>Podcast:</strong> ${metaBoostData.podcast}</div>
                            <div><strong>Episode:</strong> ${metaBoostData.episode}</div>
                            ${message ? `<div><strong>Message:</strong> <em>"${message}"</em></div>` : ''}
                            <div><strong>Boost ID:</strong> <code>${metaBoostData.boostId}</code></div>
                            <div><strong>Recipients:</strong> ${recipients.join(', ')}</div>
                        `;
                        
                        historySection.appendChild(boostEntry);
                        
                        // Reset form after 2 seconds
                        setTimeout(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            document.getElementById('payment-amount').value = '';
                            document.getElementById('payment-message').value = '';
                            document.getElementById('payment-proof').value = '';
                        }, 2000);
                        
                    } catch (error) {
                        console.error('‚ùå MetaBoost Error:', error);
                        submitBtn.innerHTML = `‚ùå Error: ${error.message}`;
                        submitBtn.disabled = false;
                        
                        setTimeout(() => {
                            submitBtn.innerHTML = 'Send metaBoost Metadata';
                        }, 3000);
                    }
                });
                
                console.log('‚úÖ MetaBoost handler setup complete');
            } else {
                console.error('‚ùå Could not find metaBoost submit button');
            }
        }, 1000);
    </script>
</body>
</html>
